// components/home/Posts.js - VERSI√ìN FINAL
import React, { useMemo } from 'react';
import { useSelector } from 'react-redux';
import { useLocation } from 'react-router-dom';
import PostCard from '../PostCard';
 
 
const Posts = ({ 
    selectedCategory, 
    selectedSubcategory, // üÜï NUEVO: Aceptar subcategor√≠a
    fromCategoryPage = false,
    fromSubcategoryPage = false, // üÜï NUEVO: Identificar si es p√°gina de subcategor√≠a
    displayMode = 'grid'
}) => {
    const location = useLocation();
    const { homePosts } = useSelector(state => state);
    
    console.log('üîç Posts - Par√°metros recibidos:', {
        selectedCategory,
        selectedSubcategory, // üÜï
        fromCategoryPage,
        fromSubcategoryPage, // üÜï
        path: location.pathname,
        postsInState: homePosts.posts?.length,
        currentCategory: homePosts.category,
        currentSubcategory: homePosts.subcategory, // üÜï
        categorySpecificPosts: homePosts.categorySpecificPosts?.length
    });
    
    // üìå L√ìGICA MEJORADA DE FILTRADO
    const displayPosts = useMemo(() => {
        let postsToShow = [];
        
        // üÜï CASO 1: P√°gina de SUBCATEGOR√çA
        if (fromSubcategoryPage || (selectedSubcategory && selectedCategory)) {
            console.log('üìÇ SubcategoryPage - Filtrando por subcategor√≠a:', {
                category: selectedCategory,
                subcategory: selectedSubcategory
            });
            
            // Opci√≥n A: Usar posts del estado que ya deber√≠an estar filtrados
            if (homePosts.posts && homePosts.posts.length > 0) {
                postsToShow = homePosts.posts.filter(post => {
                    const matchesCategory = !selectedCategory || post.categorie === selectedCategory;
                    const matchesSubcategory = !selectedSubcategory || post.subCategory === selectedSubcategory;
                    return matchesCategory && matchesSubcategory;
                });
                
                console.log(`‚úÖ Filtrados ${postsToShow.length} posts de ${homePosts.posts.length}`);
            }
            // Opci√≥n B: Filtrar desde categorySpecificPosts
            else if (homePosts.categorySpecificPosts && homePosts.categorySpecificPosts.length > 0) {
                postsToShow = homePosts.categorySpecificPosts.filter(post => 
                    post.subCategory === selectedSubcategory
                );
                console.log(`‚úÖ Desde categorySpecificPosts: ${postsToShow.length}`);
            }
        }
        
        // CASO 2: P√°gina de CATEGOR√çA espec√≠fica
        else if (fromCategoryPage || location.pathname.startsWith('/category/')) {
            console.log('üìÇ CategoryPage - Usando categorySpecificPosts');
            postsToShow = homePosts.categorySpecificPosts || [];
        }
        
        // CASO 3: Home con categor√≠a "all"
        else if (selectedCategory === 'all') {
            console.log('üè† Home - Mostrando TODOS los posts');
            postsToShow = homePosts.posts || [];
        }
        
        // CASO 4: Home con categor√≠a espec√≠fica (filtro en Home)
        else if (homePosts.categoryPosts && homePosts.categoryPosts[selectedCategory]) {
            console.log(`üè† Home - Filtrado para ${selectedCategory}`);
            postsToShow = homePosts.categoryPosts[selectedCategory] || [];
        }
        
        // üÜï CASO 5: Filtro adicional por categor√≠a (si solo hay categor√≠a)
        else if (selectedCategory && !selectedSubcategory) {
            console.log(`üîç Filtrando solo por categor√≠a: ${selectedCategory}`);
            if (homePosts.posts && homePosts.posts.length > 0) {
                postsToShow = homePosts.posts.filter(post => 
                    post.categorie === selectedCategory
                );
            }
        }
        
        console.log(`üìä Posts a mostrar: ${postsToShow.length}`);
        
        // üÜï DEPURACI√ìN: Mostrar detalles de los primeros posts
        if (postsToShow.length > 0 && selectedSubcategory) {
            console.log('üîç Primer post para verificar filtro:', {
                id: postsToShow[0]._id,
                categorie: postsToShow[0].categorie,
                subCategory: postsToShow[0].subCategory,
                title: postsToShow[0].title
            });
        }
        
        return postsToShow;
        
    }, [
        homePosts, 
        selectedCategory, 
        selectedSubcategory, 
        fromCategoryPage, 
        fromSubcategoryPage, 
        location.pathname
    ]);
    
    // üìå ESTILOS DIFERENTES SEG√öN MODO DE VISUALIZACI√ìN
    const renderPosts = () => {
        if (displayMode === 'horizontal') {
            return (
                <div style={{ 
                    display: 'inline-flex', 
                    gap: '20px', 
                    padding: '0 10px',
                    flexWrap: 'nowrap'
                }}>
                    {displayPosts.map(post => (
                        <div key={post._id} style={{ minWidth: '280px' }}>
                            <PostCard post={post} />
                        </div>
                    ))}
                </div>
            );
        }
        
        // Modo grid (por defecto)
        return (
            <div className="post_thumb">
                {displayPosts.map(post => (
                    <div key={post._id} className="post_thumb_display">
                        <PostCard post={post} />
                    </div>
                ))}
            </div>
        );
    };
    
    // üìå MENSAJES DE ESTADO VAC√çO
    if (!displayPosts || displayPosts.length === 0) {
        return (
            <div className="text-center py-5">
                <div className="display-1 mb-3">
                    {selectedSubcategory ? 'üîç' : 'üì≠'}
                </div>
                <h4 className="text-muted mb-3">
                    {selectedSubcategory 
                        ? `No hay anuncios en "${selectedSubcategory}"`
                        : selectedCategory && selectedCategory !== 'all'
                            ? `No hay anuncios en "${selectedCategory}"`
                            : 'No hay anuncios publicados a√∫n'
                    }
                </h4>
                {selectedSubcategory && (
                    <p className="text-muted">
                        Prueba a buscar en toda la categor√≠a "{selectedCategory}"
                    </p>
                )}
            </div>
        );
    }
    
    return renderPosts();
};

export default Posts;