// FieldRenderer.js - VERSI√ìN CORREGIDA
import React from 'react';
import { useTranslation } from 'react-i18next';
import { Form } from 'react-bootstrap';

// üî• IMPORTAR SOLO LO QUE EXISTE en FieldConfig
import { getVisibleFields } from './FieldConfig'; // Solo esto existe

// üî• IMPORTAR TODOS LOS COMPONENTES
import ImmobilierFields from './specificFields/ImmobiliersFields';
import VetementsFields from './specificFields/VetementsFields';
import VehiculesFields from './specificFields/VehiculesFields';
import TelephonesFields from './specificFields/TelephonesFields';
import InformatiqueFields from './specificFields/InformatiqueFields';
import ElectromenagerFields from './specificFields/ElectromenagerFields';
import SanteBeauteFields from './specificFields/SanteBeauteFields';
import MeublesFields from './specificFields/MeublesFields';
import LoisirsFields from './specificFields/LoisirsFields';
import SportFields from './specificFields/SportFields';
import AlimentairesFields from './specificFields/AlimentairesFields';
import MateriauxFields from './specificFields/MateriauxFields';
import ServicesFields from './specificFields/ServicesFields';
import VoyagesFields from './specificFields/VoyagesFields';
import EmploiFields from './specificFields/EmploiFields';
import PiecesDetacheesFields from './specificFields/PiecesDetacheesFields';

// üî• MAPEO DE COMPONENTES
const CATEGORY_COMPONENTS = {
  'voyages': VoyagesFields,
  'immobilier': ImmobilierFields,
  'automobiles': VehiculesFields,
  'vetements': VetementsFields,
  'telephones': TelephonesFields,
  'informatique': InformatiqueFields,
  'electromenager': ElectromenagerFields,
  'sante_beaute': SanteBeauteFields,
  'meubles': MeublesFields,
  'loisirs': LoisirsFields,
  'sport': SportFields,
  'alimentaires': AlimentairesFields,
  'materiaux': MateriauxFields,
  'services': ServicesFields,
  'emploi': EmploiFields,
  'pieces_detachees': PiecesDetacheesFields,
};

// üî• FUNCI√ìN shouldShowField - CREARLA AQU√ç (no existe en FieldConfig)
const shouldShowField = (fieldName, mainCategory, subCategory, postData) => {
  // Reglas para VOYAGES
  if (mainCategory === 'voyages') {
    if (subCategory === 'voyage_organise') {
      if (fieldName === 'destinationWilaya' && postData.destinationType !== 'local') {
        return false;
      }
      if (fieldName === 'destinationCountry' && postData.destinationType !== 'international') {
        return false;
      }
    }
  }

  // Reglas para IMMOBILIER
  if (mainCategory === 'immobilier') {
    const invalidFields = {
      'villa': ['etage', 'nombreEtagesImmeuble'],
      'terrain': ['etage', 'nombrePieces', 'ascenseur', 'parking', 'meuble', 'etages'],
      'local': ['etage', 'nombrePieces', 'jardin', 'piscine'],
      'terrain_agricole': ['etage', 'nombrePieces', 'ascenseur', 'parking'],
      'immeuble': ['superficieJardin', 'piscine', 'jardin']
    };

    if (invalidFields[subCategory]?.includes(fieldName)) {
      return false;
    }

    if (fieldName === 'superficieJardin' && postData.jardin !== 'oui') {
      return false;
    }
    if (fieldName === 'nombrePlacesGarage' && postData.garage === 'non') {
      return false;
    }
  }

  return true; // Mostrar por defecto
};

// üî• SISTEMA DE VISIBILIDAD SIMPLIFICADO
const useFieldVisibility = (fieldName, mainCategory, subCategory, postData) => {
  // Primero verificar reglas espec√≠ficas
  const shouldShow = shouldShowField(fieldName, mainCategory, subCategory, postData);
  if (!shouldShow) return false;

  // Luego verificar si el campo est√° en FieldConfig
  const visibleFields = getVisibleFields(mainCategory, subCategory, postData.articleType);
  const isInConfig = visibleFields.includes(fieldName);

  if (!isInConfig) {
    console.log(`‚ö†Ô∏è Campo ${fieldName} no est√° en FieldConfig para ${mainCategory}.${subCategory}`);
    return false;
  }

  return true;
};

// üî• COMPONENTE PRINCIPAL
const FieldRenderer = ({ 
  fieldName, 
  postData, 
  handleChangeInput, 
  mainCategory, 
  subCategory, 
  articleType, 
  isRTL 
}) => {
  const { t } = useTranslation();
  
  // üî• VERIFICAR VISIBILIDAD
  const isVisible = useFieldVisibility(fieldName, mainCategory, subCategory, postData);
  if (!isVisible) {
    console.log(`üö´ Campo ${fieldName} oculto`);
    return null;
  }
  
  // üî• OBTENER COMPONENTE DE CATEGOR√çA
  const CategoryComponent = CATEGORY_COMPONENTS[mainCategory];
  
  if (CategoryComponent) {
    try {
      return (
        <CategoryComponent
          fieldName={fieldName}
          postData={postData}
          handleChangeInput={handleChangeInput}
          mainCategory={mainCategory}
          subCategory={subCategory}
          articleType={articleType}
          isRTL={isRTL}
        />
      );
    } catch (error) {
      console.error(`‚ùå Error en ${mainCategory}Fields:`, error);
      return (
        <div className="alert alert-warning">
          Error cargando campo {fieldName}
        </div>
      );
    }
  }
  
  // üî• PARA CATEGOR√çAS SIN COMPONENTE ESPEC√çFICO
  console.warn(`‚ö†Ô∏è No hay componente para categor√≠a: ${mainCategory}`);
  
  return (
    <Form.Group>
      <Form.Label>
        {fieldName.replace(/_/g, ' ')}
      </Form.Label>
      <Form.Control
        type="text"
        name={fieldName}
        value={postData[fieldName] || ''}
        onChange={handleChangeInput}
        placeholder={`Enter ${fieldName}`}
        dir={isRTL ? 'rtl' : 'ltr'}
      />
    </Form.Group>
  );
};

// üî• PROPS POR DEFECTO
FieldRenderer.defaultProps = {
  fieldName: '',
  postData: {},
  handleChangeInput: () => {},
  mainCategory: '',
  subCategory: '',
  articleType: '',
  isRTL: false
};

export default FieldRenderer;