// components/CATEGORIES/FieldRenderer.js - VERSI√ìN CON ANIMACIONES
import React, { useMemo, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { Form } from 'react-bootstrap';

// üî• IMPORTAR ANIMACIONES
import { AnimatedFieldWrapper } from './FieldVariantes';

// üî• IMPORTAR CAMPOS COMUNES DESDE INDEX (ASE√öRATE DE QUE EXISTE)
import * as CamposComun from './camposComun/index';

// üî• IMPORTAR COMPONENTES ESPEC√çFICOS DE TODAS LAS CATEGOR√çAS
import ImmobilierFields from './specificFields/ImmobiliersFields';
import VetementsFields from './specificFields/VetementsFields';
import VehiculesFields from './specificFields/VehiculesFields';
import TelephonesFields from './specificFields/TelephonesFields';
import InformatiqueFields from './specificFields/InformatiqueFields';
import ElectromenagerFields from './specificFields/ElectromenagerFields';
import SanteBeauteFields from './specificFields/SanteBeauteFields';
import MeublesFields from './specificFields/MeublesFields';
import LoisirsFields from './specificFields/LoisirsFields';
import SportFields from './specificFields/SportFields';
import AlimentairesFields from './specificFields/AlimentairesFields';
import MateriauxFields from './specificFields/MateriauxFields';
import ServicesFields from './specificFields/ServicesFields';
import VoyagesFields from './specificFields/VoyagesFields';
import EmploiFields from './specificFields/EmploiFields';
import PiecesDetacheesFields from './specificFields/PiecesDetacheesFields';

// üî• IMPORTAR COMPONENTES COMUNES INDIVIDUALMENTE (BACKUP)
import MarqueField from './camposComun/MarqueField';
import ModeleField from './camposComun/ModeleField';
import PrixField from './camposComun/PrixField';
import PhoneField from './camposComun/PhoneField';
import EtatField from './camposComun/EtatField';
import TailleField from './camposComun/TailleField';
import CapaciteField from './camposComun/Capacite';
import CouleurField from './camposComun/CouleurField';

// üî• MAPEO DE COMPONENTES ESPEC√çFICOS POR CATEGOR√çA (ACTUALIZADO)
const CATEGORY_COMPONENTS = {
  'immobilier': ImmobilierFields,
  'vehicules': VehiculesFields,
  'vetements': VetementsFields,
  'telephones': TelephonesFields,
  'informatique': InformatiqueFields,
  'electromenager': ElectromenagerFields,
  'sante_beaute': SanteBeauteFields,
  'meubles': MeublesFields,
  'loisirs': LoisirsFields,
  'sport': SportFields,
  'alimentaires': AlimentairesFields,
  'materiaux': MateriauxFields,
  'services': ServicesFields,
  'voyages': VoyagesFields,
  'emploi': EmploiFields,
  'pieces_detachees': PiecesDetacheesFields,
};

// üî• MAPEO DE COMPONENTES COMUNES (BACKUP - SI EL INDEX NO FUNCIONA)
const COMMON_COMPONENTS_BACKUP = {
  'MarqueField': MarqueField,
  'ModeleField': ModeleField,
  'PrixField': PrixField,
  'PhoneField': PhoneField,
  'EtatField': EtatField,
  'TailleField': TailleField,
  'CapaciteField': CapaciteField,
  'CouleurField': CouleurField,
};

// üî• SISTEMA CENTRAL DE VISIBILIDAD (COMPLETO)
const useFieldVisibility = (fieldName, mainCategory, subCategory, articleType, postData) => {
  return useMemo(() => {
    console.log(`üîç [Visibility] Verificando ${fieldName} para ${mainCategory}.${subCategory}`);
    
    // üìå REGLAS PARA VOYAGES
    if (mainCategory === 'voyages') {
      if (subCategory === 'voyage_organise') {
        if (fieldName === 'destinationWilaya' && postData.destinationType !== 'local') {
          return false;
        }
        if (fieldName === 'destinationCountry' && postData.destinationType !== 'international') {
          return false;
        }
      }
      
      if (subCategory === 'location_vacances') {
        if (fieldName === 'communeLocation' && (!postData.wilayaLocation || postData.wilayaLocation === '')) {
          return false;
        }
      }
    }
    
    // üìå REGLAS PARA IMMOBILIER
    if (mainCategory === 'immobilier') {
      const invalidCombinations = {
        'villa': ['etage', 'nombreEtagesImmeuble'],
        'terrain': ['etage', 'nombrePieces', 'ascenseur', 'parking', 'meuble', 'etages'],
        'local': ['etage', 'nombrePieces', 'jardin', 'piscine'],
        'terrain_agricole': ['etage', 'nombrePieces', 'ascenseur', 'parking'],
        'immeuble': ['superficieJardin', 'piscine', 'jardin']
      };
      
      if (invalidCombinations[subCategory]?.includes(fieldName)) {
        return false;
      }
      
      if (fieldName === 'superficieJardin' && postData.jardin !== 'oui') {
        return false;
      }
      if (fieldName === 'nombrePlacesGarage' && postData.garage === 'non') {
        return false;
      }
    }
    
    // üìå REGLAS PARA V√âHICULES
    if (mainCategory === 'vehicules') {
      if (subCategory === 'automobiles') {
        if (fieldName === 'puissanceMoto' || fieldName === 'typeMoteurMoto') {
          return false;
        }
      }
      
      if (subCategory === 'motos') {
        if (fieldName === 'typeCarburantAuto' || fieldName === 'boiteVitesse') {
          return false;
        }
      }
    }
    
    // üìå REGLAS PARA √âLECTROM√âNAGER
    if (mainCategory === 'electromenager') {
      if (fieldName === 'modele' && !postData.marque) {
        return false;
      }
    }
    
    // Por defecto: mostrar el campo
    return true;
    
  }, [fieldName, mainCategory, subCategory, articleType, postData]);
};

// üî• COMPONENTE PRINCIPAL FIELD RENDERER CON ANIMACIONES
const FieldRenderer = ({ 
  fieldName, 
  postData, 
  handleChangeInput, 
  mainCategory, 
  subCategory, 
  articleType, 
  isRTL 
}) => {
  const { t } = useTranslation();
  
  // üîç DEBUG: Ver qu√© props estamos recibiendo
  useEffect(() => {
    console.log('üéØ FieldRenderer recibi√≥:', {
      fieldName,
      mainCategory,
      subCategory,
      articleType,
      postDataKeys: Object.keys(postData)
    });
  }, [fieldName, mainCategory, subCategory, articleType]);
  
  // üî• PASO 1: Determinar si el campo debe mostrarse
  const shouldShowField = useFieldVisibility(
    fieldName, 
    mainCategory, 
    subCategory, 
    articleType, 
    postData
  );
  
  if (!shouldShowField) {
    console.log(`üö´ Campo ${fieldName} oculto por reglas de visibilidad`);
    return null;
  }
  
  // üî• PASO 2: Verificar si es un campo com√∫n
  let commonFieldType = null;
  let CommonComponent = null;
  
  try {
    // Intentar obtener desde CamposComun (si existe)
    if (CamposComun && CamposComun.COMMON_FIELDS_MAP) {
      commonFieldType = CamposComun.COMMON_FIELDS_MAP[fieldName];
      if (commonFieldType && CamposComun[commonFieldType]) {
        CommonComponent = CamposComun[commonFieldType];
      }
    }
    
    // Si no se encontr√≥ en CamposComun, intentar con el backup
    if (!CommonComponent && COMMON_COMPONENTS_BACKUP[fieldName]) {
      commonFieldType = fieldName;
      CommonComponent = COMMON_COMPONENTS_BACKUP[fieldName];
    }
  } catch (error) {
    console.warn(`‚ö†Ô∏è Error cargando CamposComun:`, error);
  }
  
  // üî• SI ES CAMPO COM√öN, RENDERIZARLO CON ANIMACI√ìN
  if (CommonComponent) {
    console.log(`‚úÖ Usando componente com√∫n: ${commonFieldType} para ${fieldName}`);
    
    // üéØ PROPS BASE PARA TODOS LOS CAMPOS COMUNES
    const baseProps = {
      key: `${fieldName}-${mainCategory}-${subCategory}`,
      postData,
      handleChangeInput,
      isRTL,
      t,
      name: fieldName,
      label: fieldName
    };
    
    // üéØ PROPS ESPEC√çFICOS SEG√öN TIPO DE CAMPO
    let specificProps = {};
    
    // Campos que necesitan categor√≠a y subcategor√≠a
    const categoryDependentFields = ['MarqueField', 'ModeleField', 'TailleField', 'EtatField', 'PrixField', 'CapaciteField', 'CouleurField'];
    if (categoryDependentFields.includes(commonFieldType)) {
      specificProps.selectedCategory = mainCategory;
      specificProps.selectedSubCategory = subCategory;
    }
    
    // üî• MODELEFIELD - Manejador especial
    if (commonFieldType === 'ModeleField') {
      const brandKeys = [
        'marque', 'marqueauto', 'marquemoto', 'brand', 
        'marque_voiture', 'marque_moto', 'marque_appareil'
      ];
      
      let selectedBrand = '';
      for (const key of brandKeys) {
        if (postData[key]) {
          selectedBrand = postData[key];
          console.log(`üîç Encontrada marca en ${key}: ${selectedBrand}`);
          break;
        }
      }
      
      specificProps.selectedBrand = selectedBrand;
      
      // Si no hay marca, mostrar mensaje amigable
      if (!selectedBrand) {
        return (
          <AnimatedFieldWrapper key={`info-${fieldName}`}>
            <div className="alert alert-info py-2 mb-0 mt-2">
              <small>
                <i className="bi bi-info-circle me-2"></i>
                {t('select_brand_first', 'S√©lectionnez d\'abord une marque pour voir les mod√®les disponibles')}
              </small>
            </div>
          </AnimatedFieldWrapper>
        );
      }
    }
    
    // üî• MARQUEFIELD - Pasar opciones espec√≠ficas por categor√≠a
    if (commonFieldType === 'MarqueField') {
      specificProps.selectedCategory = mainCategory;
      specificProps.selectedSubCategory = subCategory;
    }
    
    // üî• PRIXFIELD - Moneda espec√≠fica
    if (commonFieldType === 'PrixField') {
      if (mainCategory === 'voyages' || mainCategory === 'emploi') {
        specificProps.currency = 'EURO';
      } else {
        specificProps.currency = 'DA';
      }
    }
    
    // üî• TAILLEFIELD - Unidades espec√≠ficas
    if (commonFieldType === 'TailleField') {
      if (mainCategory === 'electromenager' && subCategory === 'televiseurs') {
        specificProps.defaultUnit = 'pouces';
      } else if (mainCategory === 'vetements') {
        specificProps.defaultUnit = 'cm';
      } else {
        specificProps.defaultUnit = 'm';
      }
    }
    
    // üî• ETATFIELD - Opciones espec√≠ficas
    if (commonFieldType === 'EtatField') {
      if (mainCategory === 'vehicules') {
        specificProps.etatOptions = ['neuf', 'occasion', 'tres_bon_etat', 'bon_etat', 'etat_moyen', 'pour_pieces'];
      } else if (mainCategory === 'electromenager') {
        specificProps.etatOptions = ['neuf', 'tres_bon_etat', 'bon_etat', 'etat_moyen', 'reparation', 'pour_pieces'];
      } else {
        specificProps.etatOptions = ['neuf', 'occasion', 'bon_etat', 'etat_moyen'];
      }
    }
    
    // üî• RENDERIZAR CAMPO COM√öN CON ANIMACI√ìN
    return (
      <AnimatedFieldWrapper key={`common-${fieldName}-${mainCategory}`}>
        <div className={`field-renderer common-field ${commonFieldType.toLowerCase()}`}>
          <CommonComponent {...baseProps} {...specificProps} />
        </div>
      </AnimatedFieldWrapper>
    );
  }
  
  // üî• PASO 3: Usar componente espec√≠fico de categor√≠a CON ANIMACI√ìN
  const CategoryComponent = CATEGORY_COMPONENTS[mainCategory];
  
  if (CategoryComponent) {
    try {
      console.log(`üéØ Usando componente espec√≠fico: ${mainCategory}Fields para ${fieldName}`);
      
      // Props para componentes espec√≠ficos
      const categoryProps = {
        fieldName,
        mainCategory,
        subCategory,
        articleType,
        postData,
        handleChangeInput,
        isRTL,
        t
      };
      
      // üî• RENDERIZAR COMPONENTE ESPEC√çFICO CON ANIMACI√ìN
      return (
        <AnimatedFieldWrapper key={`category-${mainCategory}-${fieldName}`}>
          <div className="field-renderer category-specific">
            <CategoryComponent {...categoryProps} />
          </div>
        </AnimatedFieldWrapper>
      );
    } catch (error) {
      console.error(`‚ùå Error en ${mainCategory}Fields para '${fieldName}':`, error);
      
      // Fallback: intentar mostrar un campo gen√©rico con animaci√≥n
      return (
        <AnimatedFieldWrapper key={`fallback-${fieldName}`}>
          <Form.Group>
            <Form.Label>{fieldName} (fallback)</Form.Label>
            <Form.Control
              type="text"
              name={fieldName}
              value={postData[fieldName] || ''}
              onChange={handleChangeInput}
              placeholder={`Enter ${fieldName}`}
            />
          </Form.Group>
        </AnimatedFieldWrapper>
      );
    }
  }
  
  // üî• PASO 4: Campo gen√©rico como √∫ltimo recurso CON ANIMACI√ìN
  console.warn(`‚ö†Ô∏è [FieldRenderer] Campo '${fieldName}' sin componente para ${mainCategory}`);
  
  const getFieldType = () => {
    const fieldNameLower = fieldName.toLowerCase();
    
    if (fieldNameLower.includes('date')) return 'date';
    if (fieldNameLower.includes('email')) return 'email';
    if (fieldNameLower.includes('phone') || fieldNameLower.includes('telephone')) return 'tel';
    if (fieldNameLower.includes('prix') || fieldNameLower.includes('price') || fieldNameLower.includes('loyer') || fieldNameLower.includes('cout')) return 'number';
    if (fieldNameLower.includes('quantite') || fieldNameLower.includes('nombre') || fieldNameLower.includes('capacite') || fieldNameLower.includes('quantit')) return 'number';
    if (fieldNameLower.includes('description') || fieldNameLower.includes('content') || fieldNameLower.includes('detail')) return 'textarea';
    if (fieldNameLower.includes('password') || fieldNameLower.includes('motdepasse')) return 'password';
    if (fieldNameLower.includes('url') || fieldNameLower.includes('lien')) return 'url';
    return 'text';
  };
  
  const fieldType = getFieldType();
  const fieldLabel = t(`fields.${fieldName}`, fieldName.replace(/_/g, ' '));
  
  // üî• RENDERIZAR CAMPO GEN√âRICO CON ANIMACI√ìN
  return (
    <AnimatedFieldWrapper key={`generic-${fieldName}`}>
      <div className="field-renderer generic-field">
        <Form.Group>
          <Form.Label className={`fw-bold ${isRTL ? 'text-end d-block' : ''}`}>
            {fieldLabel}
            {fieldType === 'number' && <span className="text-danger ms-1">*</span>}
          </Form.Label>
          
          {fieldType === 'textarea' ? (
            <Form.Control
              as="textarea"
              name={fieldName}
              value={postData[fieldName] || ''}
              onChange={handleChangeInput}
              placeholder={t(`enter_${fieldName}`, `Entrez ${fieldName.replace(/_/g, ' ')}`)}
              rows={3}
              dir={isRTL ? 'rtl' : 'ltr'}
            />
          ) : fieldType === 'select' ? (
            <Form.Select
              name={fieldName}
              value={postData[fieldName] || ''}
              onChange={handleChangeInput}
              dir={isRTL ? 'rtl' : 'ltr'}
            >
              <option value="">{t('select_option', 'S√©lectionnez...')}</option>
              <option value="oui">Oui</option>
              <option value="non">Non</option>
            </Form.Select>
          ) : (
            <Form.Control
              type={fieldType}
              name={fieldName}
              value={postData[fieldName] || ''}
              onChange={handleChangeInput}
              placeholder={t(`enter_${fieldName}`, `Entrez ${fieldName.replace(/_/g, ' ')}`)}
              dir={isRTL ? 'rtl' : 'ltr'}
              min={fieldType === 'number' ? '0' : undefined}
              step={fieldType === 'number' ? 'any' : undefined}
            />
          )}
          
          {fieldType === 'number' && (
            <Form.Text className="text-muted">
              <small>
                <i className="fas fa-info-circle me-1"></i>
                {mainCategory === 'voyages' || mainCategory === 'emploi' 
                  ? t('price_in_euros', 'Prix en Euros') 
                  : t('price_in_dinars', 'Prix en Dinars alg√©riens')}
              </small>
            </Form.Text>
          )}
        </Form.Group>
      </div>
    </AnimatedFieldWrapper>
  );
};

// üî• PROPIEDADES POR DEFECTO
FieldRenderer.defaultProps = {
  fieldName: '',
  postData: {},
  handleChangeInput: () => {},
  mainCategory: '',
  subCategory: '',
  articleType: '',
  isRTL: false
};

// üî• FUNCIONES DE UTILIDAD
export const getCommonFields = () => {
  try {
    return Object.keys(CamposComun.COMMON_FIELDS_MAP || {});
  } catch {
    return Object.keys(COMMON_COMPONENTS_BACKUP);
  }
};

export const getAvailableCategories = () => Object.keys(CATEGORY_COMPONENTS);

export const isCommonField = (fieldName) => {
  try {
    return CamposComun.COMMON_FIELDS_MAP?.[fieldName] !== undefined;
  } catch {
    return COMMON_COMPONENTS_BACKUP[fieldName] !== undefined;
  }
};

// üî• HOOKS ADICIONALES √öTILES
export const useAllFields = () => {
  const commonFields = getCommonFields();
  const categories = getAvailableCategories();
  
  return {
    commonFields,
    categories,
    totalCommonFields: commonFields.length,
    totalCategories: categories.length
  };
};

// üî• COMPONENTE DE DEBUG CON ANIMACI√ìN
export const FieldRendererDebug = (props) => {
  return (
    <AnimatedFieldWrapper key="debug-wrapper">
      <div style={{border: '2px dashed #f00', padding: '10px', margin: '10px 0'}}>
        <h6>üîç DEBUG FieldRenderer</h6>
        <pre style={{fontSize: '12px'}}>
          {JSON.stringify(props, null, 2)}
        </pre>
        <FieldRenderer {...props} />
      </div>
    </AnimatedFieldWrapper>
  );
};

export default FieldRenderer;