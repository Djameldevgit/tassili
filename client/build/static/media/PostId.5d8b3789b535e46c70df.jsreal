import React, { useEffect, useState, useRef } from 'react';
import { useParams } from 'react-router-dom';
import { useSelector, useDispatch } from 'react-redux';
import { getSimilarPosts, clearSimilarPosts } from '../redux/actions/postAction';
import LoadIcon from '../images/loading.gif';
import PostCard from '../components/PostCard';
import { getDataAPI } from '../utils/fetchData';

const PostId = () => {
  const { id } = useParams();
  const dispatch = useDispatch();
  
  // ðŸ”´ REF para controlar si ya se buscaron similares
  const hasFetchedSimilarRef = useRef(false);
  const hasFetchedPostRef = useRef(false);

  // âœ… CORRECCIÃ“N: Acceder a los reducers especÃ­ficos
  const { 
    homePosts = {},      // Esto es el postReducer
    detailPost = null    // Esto es detailPostReducer
  } = useSelector(state => state);

  // Extraer los valores correctamente
  const postsArray = homePosts.posts || [];
  const similarPosts = homePosts.similarPosts || [];
  const similarLoading = homePosts.similarLoading || false;
  const detailPostData = detailPost;

  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    console.log('ðŸ” useEffect ejecutÃ¡ndose', {
      id,
      hasFetchedPost: hasFetchedPostRef.current,
      hasFetchedSimilar: hasFetchedSimilarRef.current
    });

    const fetchPost = async () => {
      // ðŸ”´ PREVENIR EJECUCIONES MÃšLTIPLES
      if (hasFetchedPostRef.current) {
        console.log('â¸ï¸ Ya se buscÃ³ el post, saltando...');
        return;
      }

      let current = null;

      // 1. Buscar en detailPost
      if (detailPostData && detailPostData._id === id) {
        current = detailPostData;
        console.log('âœ… Post encontrado en detailPost:', current._id);
      }
      // 2. Buscar en posts del postReducer
      else if (postsArray.length > 0) {
        current = postsArray.find(p => p._id === id);
        if (current) {
          console.log('âœ… Post encontrado en homePosts.posts:', current._id);
        }
      }

      // 3. Si no estÃ¡, obtener de API
      if (!current) {
        try {
          console.log('ðŸ“¥ Post no en redux, obteniendo de API...');
          const res = await getDataAPI(`post/${id}`);
          
          current = res.data.post || res.data;
          
          console.log('ðŸ“¦ Post desde API:', current._id);
          
          // Despachar para guardar en detailPost
          dispatch({ 
            type: 'GET_POST',
            payload: current 
          });
        } catch (err) {
          console.error('âŒ Error al cargar post:', err);
          setLoading(false);
          return;
        }
      }

      if (current) {
        setPost(current);
        hasFetchedPostRef.current = true;
        console.log('ðŸŽ¯ Post establecido:', current._id);

        // ðŸ”´ BUSCAR SIMILARES SOLO UNA VEZ
        if (current.categorie && current.subCategory && !hasFetchedSimilarRef.current) {
          console.log('ðŸ” Buscando posts similares (PRIMERA VEZ)...');
          hasFetchedSimilarRef.current = true;
          dispatch(getSimilarPosts(id));
        } else if (!current.categorie || !current.subCategory) {
          console.warn('âš ï¸ Post sin categorÃ­a completa');
          dispatch(clearSimilarPosts());
        }
      }

      setLoading(false);
    };

    fetchPost();

    // Cleanup cuando el componente se desmonta
    return () => {
      console.log('ðŸ§¹ Cleanup PostId');
      hasFetchedPostRef.current = false;
      hasFetchedSimilarRef.current = false;
      dispatch(clearSimilarPosts());
    };
  }, [id, dispatch]); // ðŸ”´ REMOVER detailPostData y postsArray de dependencias

  // ðŸ”´ AGREGAR useEffect SEPARADO para cambios en detailPost
  useEffect(() => {
    // Si detailPost cambia y coincide con el ID actual, actualizar el post
    if (detailPostData && detailPostData._id === id && !hasFetchedPostRef.current) {
      console.log('ðŸ”„ detailPost actualizado, sincronizando...');
      setPost(detailPostData);
      hasFetchedPostRef.current = true;
    }
  }, [detailPostData, id]);

  // Render loading
  if (loading) {
    return (
      <div className="text-center my-5">
        <img src={LoadIcon} alt="loading" className="d-block mx-auto" />
        <p>Cargando...</p>
      </div>
    );
  }

  // Render si no hay post
  if (!post) {
    return (
      <div className="text-center my-5">
        <h4>Post no encontrado</h4>
        <p>El post que buscas no existe o ha sido eliminado.</p>
      </div>
    );
  }

  console.log('ðŸ“Š Datos para render:', {
    postId: post._id,
    similarPostsCount: similarPosts.length,
    similarLoading,
    hasFetchedSimilar: hasFetchedSimilarRef.current
  });

  return (
    <div className="container py-4">
      {/* DEBUG INFO (temporal) */}
      <div style={{ 
        background: '#f8f9fa', 
        padding: '10px', 
        borderRadius: '5px', 
        marginBottom: '20px',
        fontSize: '12px'
      }}>
        <strong>DEBUG:</strong> Post: {post._id} | Similares: {similarPosts.length} | Loading: {similarLoading ? 'SÃ­' : 'No'}
      </div>

      {/* Post principal */}
      <div className="mb-5">
        <PostCard post={post} />
      </div>

      {/* Posts similares */}
      {post.categorie && post.subCategory && (
        <div className="similar-section mt-5">
          <div className="d-flex align-items-center justify-content-between mb-4">
            <h3 className="mb-0">Posts similares</h3>
            {similarPosts.length > 0 && (
              <span className="badge bg-primary">
                {similarPosts.length} encontrados
              </span>
            )}
          </div>

          {similarLoading && (
            <div className="text-center my-4">
              <img src={LoadIcon} alt="loading" className="d-block mx-auto" />
              <p>Buscando posts similares...</p>
            </div>
          )}

          {!similarLoading && similarPosts.length === 0 && (
            <div className="alert alert-info">
              <p className="mb-0">No se encontraron posts similares</p>
            </div>
          )}

          {!similarLoading && similarPosts.length > 0 && (
            <div className="row">
              {similarPosts.map(item => {
                // Evitar mostrar el mismo post
                if (item._id === post._id) return null;
                
                return (
                  <div key={item._id} className="col-md-6 col-lg-4 mb-4">
                    <PostCard post={item} />
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default PostId;